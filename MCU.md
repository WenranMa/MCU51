# 嵌入式 

## 硬件相关
TTL电平（晶体管-晶体管逻辑电平），大于2.4V为高，小于0.4V为低。51单片机（89C52RC）高电平为5V。

串口RS232电平，高为-12V，低为+12V。CH340是串口芯片，做电平转换，RS232转为TTL？

```
同或：必须相同，否则没有（为0）。
异或：必须不同，否则没有。
```
```
电容：
1F = 1000000uF（微法）
1uF = 1000nF
1nF = 1000pF
电容104表示10x10^4pF，也就是100nF。

板上电容：
470uF电容做储能，储备电荷量，防止供电电压被拉低。
100nF电容做滤波，防止浪涌。
```

## 51 C语言
```c
//头文件<reg51.h>包含了寄存器的一些定义。
sfr     //声明一个特殊功能寄存器
sfr16   //声明一个16位特殊功能寄存器
sbit    //特殊功能位声明，也就是声明一个寄存器中的某一位
sbit Led = P0^0; //表示声明P0寄存器的最低位
```

```c
//<intrins.h>中保护左移右移函数：
unsigned char _crol_(unsigned char c, unsigned char b);
//将c循环左移b位
unsigned char _cror_(unsigned char c, unsigned char b);
//将c循环右移b位
```

## 74HC573锁存器
20个管脚，包括Vcc，GND，D1~8为数据输入，Q1~8为输出。OE是输出使能，低电平有效，LE是锁存控制。

|Input  |       |       |Output |
|-------|-------|-------|-------|
|OE     |LE     |D      |Q      |
|L      |H      |H      |H      |
|L      |H      |L      |L      |
|L      |L      |H/L    |Q0（上一次状态）|
|H      |H/L    |H/L    |Z（高阻态，不可控）|

- OE为低，LE为低时，输出跟随输入。
- OE为低，LE为高时，不管输入是什么，输出都保持上一次的状态。
- OE高时，输出不可控。

所以板上的OE都接地。通过控制LE来控制输出。

## 4位数码管
一共12个引脚，其中ABCDEFGH是8段LED，WE1-4负责位选择。

板上两个4位数码管，一共8位显示，两个74HC573，一个负责数码管位选择，一个负责实际数字（或者简单字母）选择。

## 周期
- 时钟周期：外接晶振的倒数。单片机最小时间单位，单片机完成一个基本动作。
- 状态周期：时钟周期的2倍。
- 机器周期：12个时钟周期，6个状态周期。一个机器周期完成一个基本操作，如存储器读、写等。
- 指令周期：完成一个指令的周期，1~4个机器周期组成。

```c
for(i=1000; i>0; i--){
	for(j=110; j>0; j--){			
	}
}
//为什么循环110000次大概时1秒?
```

消影？？？

## PSW寄存器
Program Status Word.

## 中断
中断源：52型号有6个中断源（优先级从高到低，中断号从0到5，c语言用）。
- INT0 外部中断0，P3.2管脚引入，低电平或下降沿触发，优先级最高。
- T0 定时器/计数器0中断，T0计数器计满归零触发。
- INT1 外部中断1，P3.3管脚引入，低电平或下降沿触发。
- T1 定时器/计数器1中断，T1计数器计满归零触发。
- TI/RI 串口中断。
- T2 定时器/计数器2中断，T2计数器计满归零触发，优先级最低，52独有。

中断可以嵌套。

### 中断允许寄存器IE
- EA：中断总允许位。EA=1，开放中断；EA=0，禁止所有的中断请求。
- EX0：外部中断0允许位。EX0=1，允许外部中断0中断；EX0=0，禁止外部中断0中断。
- ET0：T0溢出中断允许位。ET0=1，允许T0中断；ET0=0，禁止T0中断。
- EX1：外部中断1允许位。EX1=1，允许外部中断1中断；EX1=0，禁止外部中断1中断。
- ET1：T1溢出中断允许位。ET1=1，允许T1中断；ET1=0，禁止T1中断。
- ES：串行中断允许位。ES=1，允许串行口中断；ES=0，禁止串行口中断。
- ET2：T2溢出中断允许位。ET2=1，允许T2中断；ET2=0，禁止T2中断。

### 中断优先寄存器IP

### 定时器/计数器
定时器/计数器是一个16位加1计数器。它随着计数器的输入脉冲进行自加1，也就是每来一个脉冲，计数器就自动加1。这里的脉冲有两个来源：
- 时钟振荡器的12分频
- 外部引脚T0，T1

简单说定时器的中断有两种方式，一种是计数值达到最大（定时或计数都可以），会产生溢出中断。另一种是外部脉冲触发中断（只有计数时），此时的中断标志位IT需要软件清除。

当加到计数器为全1时，再输入一个脉冲就使计数器回零，且计数器的溢出使相应的中断标志位置1（TCON的TF0，TF1），向CPU发出中断请求（定时/计数器中断允许时）。如果定时/计数器工作于定时模式，则表示定时时间已到；如果工作于计数模式，则表示计数值已满。

可见，由溢出时计数器的值减去计数初值才是加1计数器的计数值。

定时/计数器的实质是加1计数器（16位），由高8位和低8位两个寄存器THx和TLx组成。

当选择计数功能是每一次脉冲，TH或TL寄存器的值会自动加一，当超出选定模式容纳的最大计数值是，TF会硬件置一，产生中断。

选择定时功能时，每一个机器周期都会自动加一，一直加到选定模式的容许的最大值，此时会出发中断。

TMOD是定时/计数器的工作方式寄存器，确定工作方式和功能；TCON是控制寄存器，控制T0、T1的启动和停止及设置溢出标志。

#### TMOD工作方式寄存器
工作方式寄存器TMOD用于设置定时/计数器的工作方式，低四位用于T0，高四位用于T1。
|D7  |D6  |D5  |D4  |D3  |D2  |D1  |D0  |
|----|----|----|----|----|----|----|----|
|GATE|C/T |M1  |M0  |GATE|C/T |M1  |M0  |

GATE是门控位： 
- GATE=0时，定时器的启动由TCON中的TR0或TR1控制。TR0/TR1为1，就可以启动定时/计数器工作；
- GATA=1时，要用软件使TR0或TR1为1，同时外部中断引脚INT0/1也为高电平时，才能启动定时/计数器工作。

C/T :定时/计数模式选择位。
- C/T=0为定时模式。
- C/T=1为计数模式。

M1/M0：工作方式设置位。定时/计数器有四种工作方式。

|M1  |M0  |工作方式                                     |
|----|----|--------------------------------------------|
|0   |0   |方式0，13位计数                              |
|0   |1   |方式1，16位计数                              |
|1   |0   |方式2，自动重装初值的8位计数                  |
|1   |1   |方式3，只适用于T0，分成两个8位计数器，T1停止计数|

`注意TMOD不可以位寻址。`

#### TCON控制寄存器
TCON的低4位用于控制外部中断，TCON的高4位用于控制定时/计数器的启动和中断申请。
|D7  |D6  |D5  |D4  |D3  |D2  |D1  |D0  |
|----|----|----|----|----|----|----|----|
|TF1 |TR1 |TF0 |TR0	|IE1 |IT1 |IE0 |IT0 |

TF1（TCON.7）：T1溢出标志位。T1计数溢出时由硬件自动置TF1为1。CPU响应中断后TF1由硬件自动清0。T1工作时，CPU可随时查询TF1的状态。TF1也可以用软件置1或清0，同硬件置1或清0的效果一样。

TR1（TCON.6）：T1运行控制位。TR1置1时，T1开始工作；TR1置0时，T1停止工作。TR1由软件置1或清0。所以，用软件可控制定时/计数器的启动与停止。(至于TMOD中GATE的设置，如果GATE=1，还需要外部中断源INT1为高才能控制。)

TF0（TCON.5）：T0溢出标志位，其功能与TF1类同。

TR0（TCON.4）：T0运行控制位，其功能与TR1类同。

IE1：外部中断源1（INT1，P3.3）标志。IE1＝1，外部中断1正在向CPU请求中断，当CPU响应该中断时由硬件清零IE1。

IT1：外部中断源1触发方式控制位。
- IT1＝0，外部中断1程控为电平触发方式，当INT1（P3.3）输入低电平时，置位IE1。
- IT1=1时，为边沿触发方式。

IE0：外部中断源0（INT0，P3.2）标志，同IE1。

IT0：外部中断源0触发方式控制位。同IT0。

#### 初始值计算
机器周期也就是CPU完成一个基本操作所需要的时间。

使用12MHZ的外部晶振，时钟周期(振荡周期) = 1/12MHz，机器周期(1个机器周期等于12个振荡周期) = (1/12MHz) * 12 = 1us。（如果采用方式1即为16位定时/计数器，那么一次记满就最多为65536 * 1us = 65536us）

如果用定时器0，并采用方式一(16位定时/计数器)，而我们定时1ms的初值是多少呢，1ms/1us=1000。也就是要计数1000个数，初值 = 65535 - 1000 + 1（因为实际上计数器计数到65536才溢出）= 64536 = 0xFC18（可这样赋值：TH0 = 0xFC，也就是((65536-1000)/256)，TL0=0x18，即((65536-1000)%256))，256就是8位的最大值。

比如定时50ms，如果晶振是12M，那么一个机器周期是12 * 1 / 12MHz = 1us。如果我们定时50ms，那么计数器加了50ms/1us = 50000次。初始值 = 65536-50000 = 15536。

11.0592MHz的晶振，一个机器周期 = 12 * (1/11.0592Mhz) ~= 1.09us，如果时50ms，50ms / 1.09us = 45872，初值 = 65536 - 45872 = 10664。


## 按键
### 独立按键
### 矩阵键盘

## 蜂鸣器
板载时有源蜂鸣器，只要加上电源，就会发出固定频率的声音，不可以调节频率。

## 8x8点阵
一共16个引脚，组成64阵列。

### 74HC595
是一个8位串行输入，并行输出的芯片。两片595级联可以实现16位并行输出，刚好可以驱动8x8点阵。

|管脚 |说明     |
|-----|--------|
|Q0~Q7| 8位并行数据输出 |
|GND  |	地             |
|Q7’  |	串行数据输出，级联输出端，接下一个595的DS端 |
|MR   |	低电平有效，清空移位寄存器中的数据，一般不用，接高电平即可 |
|SH_CP或SCK | 移位寄存器时钟引脚，上升沿时，移位寄存器中的数据整体后移，并接受新的数据(从DS输入)。|
|ST_CP或RCK | 存储寄存器时钟输入引脚。上升沿时，数据从移位寄存器并行输出到Q0~Q7 | 
|OE   |	低电平有效，输出使能控制脚，所以接GND |
|DS	  |	串行数据输入引脚 |
|VCC  |	电源  |


## AD

- 分辨率：8位，满刻度的1/2^8，比如8位5V满刻度，分辨率就是5V/256 ~= 20mV。
- 量化误差：用数字量表示模拟量的过程，叫量化。要准确表示模拟量，需要无限位。
- 偏移误差：
- 满刻度误差：
- 线性度：
- 绝对精度：
- 转换速度：

ADC类型:
- 双积分
- 逐次逼近：二分查找原理。内置逐次逼近寄存器，首先产生8位最大值的一半 1000 0000，用这个值的产生的模拟量Vn与Vin比较，如果Vin < Vn，最高位1保留，否则置0。再看第二位，x100 0000，再比较，直到最后一位确定。
- 并行比较

### XPT2046
- 4线电阻式触摸控制器，内置12位，125KHz转换速率逐次逼近AD转换器。
- 工作电压1.5V-5.25V。
- 三线制SPI（Serial Peripheral Interface，串行外设接口）通信接口。 
- TSSOP 16脚封装引脚：
	1. Vcc
	2. XP，模拟信号差分输入，也可以单端输入使用，单端输入时，是与GND的差分值。
	3. YP
	4. XN
	5. YN
	6. GND
	7. VBAT，电池监视输入端，也可以做模拟输入。
	8. AUX，ADC辅助输入通道，也可以做模拟输入。
	9. VREF，参考电压输入/输出。
	10. IOVDD，数字电源输入端。
	11. PENIRQ，笔接触中断引脚。
	12. DOUT，串行数据输出端。数据在DCLK的下降沿移出，当CS为高电平时为高阻状态。
	13. Busy，忙信号，当CS为高电平时为高阻状态。
	14. DIN，串行数据输入端。当CS为低电平时，数据在DCLK上升沿锁存进来。
	15. CS，片选信号。控制转换时序和使能串行输入输出寄存器，高电平时ADC掉电。
	16. DCLK，外部时钟信号输入。

所以最多有四通道（XP，YP，Vbat，AUX）模拟输入。

差分信号可以抑制共模干扰。比如v+输入2v，v-输入1v，最终信号是2-1 = 1v。共模干扰就是同时干扰v+，v-，干扰后v+变为2.15v，v-变为1.15v，差值仍是1v。

DIN输入的是命令信号，前8个时钟用来通过DIN引脚输入控制字节。

控制字节：
- 起始位，第一位，即S位。控制字的首位必须是1，即S＝1。在XPT2046的DIN引脚检测到起始位前，所有的输入将被忽略。
- 地址，接下来的3位（A2、A1和A0）选择多路选择器的现行通道，触摸屏驱动和参考源输入。参考Data sheet.
- MODE，模式选择位，用于设置ADC的分辨率。MODE＝0，下一次的转换将是12位模式；MODE＝1，下一次的转换将是8位模式。
- SER/DFR，SER/DFR位控制参考源模式，选择单端模式（SER/DFR＝1），或者差分模式（SER/DFR＝0）。
- PD0和PD1，低功率模式选择位，若为11，器件总处于供电状态，若为00，器件在模数转换之间处于低功率模式。


### 光敏电阻
光照后，阻值会下降。

### 热敏电阻
大多数位负温度系数，阻值随温度上升而减小。

### 电位器
可调电阻

## 1602液晶





---